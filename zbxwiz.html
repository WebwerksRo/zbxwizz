<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="lib/bootstrap.min.css">
    <link rel="stylesheet" href="lib/select2.min.css">
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="node_modules/jsoneditor/dist/jsoneditor.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark d-flex fixed-top">
        <div class="flex-grow-1">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link active btn btn-secondary" href="#" role="button" data-toggle="modal" data-target="#loadCsvModal">Load CSV</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active btn btn-secondary" href="#" onclick="save_data()">Save CSV</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active btn btn-secondary" href="#" role="button" data-toggle="modal" data-target="#pullZbxModal">ZBX fetch</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active btn btn-secondary" href="#" role="button" data-toggle="modal" data-target="#pushZbxModal">ZBX push</a>
                </li>
            </ul>
        </div>
        <div><a class="nav-link" href="#"  role="button" data-toggle="modal" data-target="#zbxConfigModal"><img src="assets/zbx_logo.png" width="30" id="zbxLogo" class="notConnected"></a></div>
    </nav>
    <div class="" style="margin-top: 46px">
        <table id="preview" border="1" cellpadding="2">
            <thead style="background-color: burlywood;"></thead>
            <tbody></tbody>
        </table>
    </div>
    <datalist id="fields"></datalist>
    <div class="modal" id="pullZbxModal">
        <form id="pullZbxForm">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Pull data from Zabbix</h5>
                    </div>
                    <div class="modal-body">
                        <div class="form-row">
                            <div class="col">
                                <div class="form-group ">
                                    <label>Resource</label>
                                    <select class="custom-select custom-select-sm" name="resource">
                                        <option>host</option>
                                        <option>hostgroup</option>
                                        <option>template</option>
                                        <option>template</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label>Post process</label>
                                    <select class="custom-select custom-select-sm mt-1" name="postprocess">
                                        <option value="update">Update existing</option>
                                        <option value="new">New data</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="input-group input-group-sm mb-2">
                            <select class="custom-select" onchange="pullReqTplEditor.setText(localStorage.getItem($(this).val()))" id="pullReqTemplates"></select>
                            <div class="input-group-append">
                                <button class="btn btn-secondary">Remove current template</button>
                            </div>
                        </div>
                        <div id="pullReqTplEditor" style="height: 500px;"></div>
                        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="pull(pullReqTplEditor.getText(),this.form)">Pull</button>
                        <button type="button" class="btn btn-info" onclick="save_req_tpl(pullReqTplPfx,'#pullReqTemplates',pullReqTplEditor)">Save as template</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    

    <div class="modal" id="pushZbxModal">
        <form id="pushZbxForm">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        Push data to Zabbix
                    </div>
                    <div class="modal-body">
                        <fieldset>
                            <legend>Update</legend>
                            <div>
                                Who<br>
                                <select>
                                    <option>host</option>
                                    <option>name</option>
                                    <option>groups</option>
                                    <option>tags</option>
                                </select>
                            </div>
                            <div>
                                Select by<br>
                                <select id="dataSourceFld"></select>
                            </div>
                            <div style="border: solid black 1px" class="p-2 mt-2">
                                What<br>
                                <select name="what">
                                    <option>host</option>
                                    <option>name</option>
                                    <option>groups</option>
                                    <option>tags</option>
                                </select><br>
                                Update by
                                <select id="selectBy">
                                    <option>hostid</option>
                                    <option>host</option>
                                    <option>name</option>
                                </select>
                                Data source col
                                <select class="fieldSelect"></select>
                                <select name="whatColumn"></select><br>
                                <select name="howToUpdate">
                                    <option>update</option>
                                    <option>replace</option>
                                </select>
                                <button onclick="$(this).parent().clone().insertAfter(this.parentNode)" type="button">One more</button>
                            </div>
                        </fieldset>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="push_changes(this.form)">Load</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
   
    <div class="modal" id="loadCsvModal">
        <form id="loadCvsForm">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        Load CSV file
                    </div>
                    <div class="modal-body">
                        <input type="file" name="file">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="load_csv(this.form.file)">Load</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <div class="modal" id="zbxConfigModal">
        <form id="zbxConfigForm">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        Zabbix connection
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="zbxUrlInput">API URL</label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <button class="btn btn-outline-secondary" type="button" id="button-addon1" onclick="load_api_url(this)">Load</button>
                                </div>
                                <input type="text" class="form-control" name="url" id="zbxUrlInput">
                            </div>
                        </div>  
                        <div class="form-group">
                            <label for="zbxTokenInput">API Token</label>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <button class="btn btn-outline-secondary" type="button" id="button-addon1" onclick="load_api_key(this)">Load</button>
                                </div>
                                <input type="text" class="form-control" name="token" id="zbxTokenInput">
                            </div>
                        </div>  
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="save_zbx_config(this.form)">Save config</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <div class="d-none">
        <div id="transformTpl" class="transform">
            <form class="p-0 m-0">
                <textarea onkeyup='transform_data(this)' name="xpression" placeholder='transform' rows=1 
                    onfocus="$(this).parents('.transform').addClass('active')"
                    onblur="let slf=this;setTimeout(()=>$(slf).parents('.transform').removeClass('active'),400)"></textarea>
                <div class="mt-0">
                    <textarea class="alert alert-secondary p-1 m-0" placeholder="preview" name="preview" disabled></textarea>
                    <button class="btn btn-secondary btn-sm w-100 mt-1" type="button" onclick="transform_data(this,true)">Apply</button>
                </div>
            </form>
        </div>
        <div class="dropdown" id="filterTpl">
            <a class="btn btn-info dropdown-toggle btn-sm w-100" href="#" role="button" data-toggle="dropdown" aria-expanded="false">
              Filter
            </a>
            <div class="dropdown-menu bg-light">
                <form class="p-2 m-0">
                    <div class="form-group">
                        <select onchange="filter_rows(this.form)" name="filter" class="custom-select custom-select-sm w-100">
                            <option value="">Select filter</option>
                            <option value="^$">Empty</option>
                            <option value=".+">Not empty</option>
                            <option value="^((?!{value}).)*$">Does not contain</option>
                            <option value="{value}">Contains</option>
                            <option value="^{value}">Starts with</option>
                            <option value="{value}$">Ends with</option>
                            <option value="^{value}$">Exact match</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <input type="text" name="term" class="form-control form-control-sm" onkeyup="filter_rows(this.form)">
                    </div>
                    <div class="btn-group w-100 btn-group-sm" role="group" aria-label="Basic example">
                        <button class="btn btn-primary  w-100" onclick="filter_rows(this.form);$(this).parents('.dropdown-menu').prev().dropdown('hide');" type="button">Apply</button>
                        <button class="btn btn-secondary w-100" onclick="this.form.reset();filter_rows(this.form);$(this).parents('.dropdown-menu').prev().dropdown('hide')" type="button">Clear</button>
                    </div>
                  </form>
            </div>
          </div>
    </div>
    
<script src="lib/jquery.js"></script>
<script src="lib/bootstrap.min.js"></script>
<script src="lib/zbx.js"></script>
<script src="lib/papaparse.min.js"></script>
<script src="lib/select2.min.js"></script>
<script src="node_modules/jsoneditor/dist/jsoneditor.min.js"></script>


<script lang="javascript" src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
<script>
    let zbx,apiUrl,apiKey;
    let specs = {};
    async function get_specs() {
        specs.host = await (await fetch("hosts_spec.json")).json();
    }

    function pull(template,form) {
        if(["host"].indexOf(form.resource.value)===-1)
            return;
        wd = 0;
        dt.rows().forEach((row)=>{
            wd++;
            if(wd>10) return;
            with($(row).data()) {
                let req = eval("`"+template+"`");
                try{
                    zbx.get(form.resource.value,JSON.parse(req)).then((resp)=>console.log(resp));
                }
                catch(e) {
                    console.log(e);
                }
                
            }
        })
    }

    function dataTable(id) {
        const dt = {
            el: $(id),
            rows: function(){
                return this.el.find("tbody>tr").toArray();
            },

        }
        return dt;
    }

    

    function downloadBlob(content, filename, contentType) {
        // Create a blob
        var blob = new Blob([content], { type: contentType });
        var url = URL.createObjectURL(blob);

        // Create a link to download it
        var pom = document.createElement('a');
        pom.href = url;
        pom.setAttribute('download', filename);
        pom.click();
    }

    function save_data() {
        let data = []
        $("#preview>tbody>tr").each((idx,row)=>{
            let rec = {};
            let cells = $(row).children().toArray();
            cells.shift(-1);
            cells.forEach((cell)=>rec[$(cell).data("fld")]=$(cell).text());
            data.push(rec);
        })
        console.log(data);
        csv = Papa.unparse(data,{
            quotes: true, //or array of booleans
            quoteChar: '"',
            escapeChar: '"',
            delimiter: ",",
            header: true,
            newline: "\n",
            skipEmptyLines: false, //other option is 'greedy', meaning skip delimiters, quotes, and whitespace.
            columns: null //or array of strings
        });
        console.log(csv);
        downloadBlob(csv,"backup.csv","text/csv;charset=utf-8;");
    }
    

    let overlay = $("#overlay");
    
    async function sync() {
        if(zbx==null)
            return ("ZBX not connected");

        let selFld = $("#selectFld").val();
        let cnt=0;
        $("#preview>tbody>tr").toArray().forEach((row)=>{
            cnt++;
            //if(cnt>10) return;
            let data = $(row).data("csvData");
            let params = {};
            if(data[selFld].trim().length==0) return;
            switch($("#selectBy").val()) {
                case "hostid":
                    params.hostids = data[selFld]
                    break;
                case "name":
                    params.filter = {
                        name:[data[selFld]]
                    }
                    break;
                case "host":
                    params.filter = {
                        name:[data[selFld]]
                    }
                    break;
            }
            let output = $("#output").val()
            params.output = output.length==0 ? "extend" : output;
            
            $("#include").val().forEach(incl=>{
                switch(incl) {
                    case "selectParentTemplates":
                        params[incl] = ["templateid","host"];
                        break;
                    case "selectTags":
                        params[incl] = "extend";
                        break;
                    case "selectHostGroups":
                        params[incl] = "extend";
                        break;
                }
                
            })
            //console.log(params);
            //return;
            zbx.get("host",params).then((resp)=>{
                let data = resp.result.pop();
                if(!data) return $(row).remove();
                $(row).data("zbxData",data).attr("title",JSON.stringify(data)).addClass("synced");
                console.log("Recv data",params,data);
            }).catch(e=>console.log(e));
        })
    }
    function dbg(msg,cls,clear=false) {
        
        let area = $('#debug');
        if(clear) area.empty();
        $("<p>").text(msg).addClass(cls).appendTo(area)[0].scrollIntoView();
    }

    function transform_data(src,apply=false){
        console.log("transform",src,apply);
        let el = src.form.xpression;
        let col = $(el).parents("th").data("col");
        let expr = el.value;

        function transform(cell) {
            let data = $(cell.parentNode).data();
            //console.log(cell,data);
            $(cell.parentNode).children().each((idx,cell)=>{
                if(idx==0)return;
                data["col"+idx] = $(cell).text();
            })
            data.content = $(cell).text();
            data.self = data.content;
            if(expr!=="")
                with(data){
                    return eval(expr);
                }
        }
        
        let colCells = $("#preview>tbody>tr:not(.d-none)>td:nth-child("+(col+1)+")");
        if(!apply)  {
            console.log(colCells,colCells.first());
            console.log(el);
            try {
                let newVal = transform(colCells[0]);
                
                el.form.preview.value = (typeof newVal!=="undefined")? newVal : $(colCells[0]).text()
            }
            catch(e) {
                console.log(e);
                el.form.preview.value = "Error: "+e.message
            }
            return;
        }
        

        console.log("transform all");
        colCells.each((idx,cell)=>{
            $(cell).html(transform(cell));
        });
        src.form.reset();
    }

    function filter_rows(form){
        let rgx = form.filter.value.replaceAll("{value}",form.term.value);
        console.log(rgx);
        let th = $(form).parents("th");
        let col = th.data("col");
        $("#preview>tbody>tr").removeClass("d-none");
        console.log("remove filter",th.removeClass("filterActive"));
        if(!rgx.length) return;
        rgx = new RegExp(rgx,"i");

        console.log("add filter",th.addClass("filterActive"));
        $("#preview>tbody>tr>td:nth-child("+(col+1)+")").each((idx,cell)=>{
            let val = $(cell).text();
            if(!rgx.test(val)) {
                $(cell.parentNode).addClass("d-none");
            }
        })
        
    }


    function delete_selected() {
        $("#preview>tbody input:checked").each((idx,item)=>$(item).parents("tr").remove());
    } 
    function toggle_all_visible(src){
        let inps = $("#preview>tbody>tr:not(.d-none) input[type=checkbox]");
        
        let checked = src.checked;
        inps.each((idx,inp)=>{
            inp.checked=checked
        })
    }

    function toggleSmall(event) {
        let el = $(event.target);
        let col = el.data("col")+1;
        if(el.hasClass("small")) {
            $("#preview>thead>tr:first-child>th:nth-child("+col+")").removeClass("small");
            $("#preview>thead>tr:not(:first-child)>th:nth-child("+(col-1)+")").removeClass("small");
            $("#preview td:nth-child("+col+")").removeClass("small");
        }
        else {
            $("#preview>thead>tr:first-child>th:nth-child("+col+")").addClass("small");
            $("#preview>thead>tr:not(:first-child)>th:nth-child("+(col-1)+")").addClass("small");
            $("#preview td:nth-child("+col+")").addClass("small");
        }
    }
    
    function addCol(){
        let headerLastEl = $("#preview>thead>tr:first-child>th:last-child");
        let transformRow = $("#preview>thead>tr:last-child");
        let filterRow = $("#preview>thead>tr:nth-child(2)");
        
        let col = transformRow.children().length+1;
        $("<th>").data("fldname","col"+col).attr("data-col",col).append($("#transformTpl").clone().attr("id",null)).appendTo(transformRow);
        $("<th>").data("fldname","col"+col).attr("data-col",col).append($("#filterTpl").clone().attr("id",null)).appendTo(filterRow);

        //$("<th>").data("fldname","col"+col).attr("data-col",col).html("<textarea onchange='transform(this)' placeholder='transform' rows=1>").appendTo(transformRow);
        //$("<th>").data("fldname","col"+col).attr("data-col",col).html("<textarea onkeyup='filter(this)' placeholder='filter'>").appendTo(filterRow);
        $("<th>").on("click",toggleSmall).attr("data-col",col).text("col"+col).insertBefore(headerLastEl);
        $("#preview>tbody>tr").each((idx,row)=>{
            $("<td contenteditable='true'>").appendTo(row);
        })
    }

    

    function display_data() {
        let data = localStorage.getItem("csvData");
        if(!data) return;
        data = JSON.parse(data);
        let headerRow = $("<tr>").appendTo($("#preview>thead").empty());
        let filterRow = $("<tr>").appendTo("#preview>thead");
        let transformRow = $("<tr>").appendTo("#preview>thead");
    
        let tbody = $("#preview>tbody").empty();
        let fields = data.meta.fields;
        $("#fields").empty()
        let selectFld = $(".fieldSelect").empty();
        let dataSourceFld = $("#dataSourceFld").empty();
        let col = 0;
        $("<th rowspan='3'>").html("<input type='checkbox' onchange='toggle_all_visible(this)'> <button onclick='delete_selected()'>-</button>").appendTo(headerRow);
        fields.forEach(fld => {
            col++;
            $("<th>").data("fldname",fld).attr("data-col",col).append($("#transformTpl").clone().attr("id",null)).appendTo(transformRow);
            $("<th>").data("fldname",fld).attr("data-col",col).append($("#filterTpl").clone().attr("id",null)).appendTo(filterRow);
            $("<th>").on("click",toggleSmall).attr("data-col",col).html("col"+col+"<br>"+fld).appendTo(headerRow);
            $("<option>").attr("value",fld).appendTo("#fields");
        });

        $("<th rowspan='3'>").html("<button onclick='addCol()'>+</button>").appendTo(headerRow);
        
        for(let i=0;(i<data.data.length);i++) {
            let trow = $("<tr>").appendTo(tbody).data("csvData",data.data[i]);
            let idx = 0;
            $("<td>").html("<input type='checkbox'>").appendTo(trow);
            fields.forEach(fld => {
                idx++;
                data.data[i][idx] = data.data[i][fld];
                
                trow.data(fld,data.data[i][fld])
                    .data("col"+idx,data.data[i][fld]);

                $("<td contenteditable='true'>").text(data.data[i][fld])
                    .attr("data-fld",fld)
                    .attr("data-col",idx)
                    .appendTo(trow);
            });
        }
    }
    
    


    Array.prototype.unique = function(){
        function distinct(value, index, array) {
            return array.indexOf(value) === index;
        }    
        return this.filter(distinct);
    }

    function load_csv(input) {
        let a = $(input).parse({
            config: {
                header: true,
                complete: (data)=>{
                    console.log(data);
                    localStorage.setItem("csvData",JSON.stringify(data))
                    display_data()
                }
            }
        });
        console.log(a);
    }

    function push_changes() {
        let wd = 0;
        $("#preview>tbody>tr").toArray().forEach((row)=>{
            // not selected => skip
            if(!$(row).find("input")[0].checked) return;
            
            let rowData = $(row).data();
            // no zbx data => skip
            if(!rowData.zbxData){
                console.log("Skip No ZBX data");
                return;
            } 
            
            // already processed => skip
            // if(rowData.zbxData.tags.filter(tag=>tag.name=="ZHP_UPDATE").length) {
            //     console.log("Skip already done",rowData.zbxData.host);
            //     return;
            // }
            wd++;
            //if(wd>1) return;
            //console.log(rowData);
            
            let data = {};
            let cnt=0;
            $(row).children(":not(:first-child)").each((idx,cell)=>{
                let $cell = $(cell);ccc
                let cellData = $cell.data()
                if(cellData.fld) {
                    data[cellData.fld] = $cell.text();
                }
                data["col"+cnt] = $cell.text();
            });
            if(!data.hostid) return;
            //console.log(data);
            let tags = JSON.parse(data.Notes).map((item)=>{
                    let tag = Object.keys(item).pop();
                    return {
                        tag: tag,
                        value: item[tag]
                    };
                });
            let hostgroups = data.Action.split(",").map(grpid=>{return {groupid:grpid}});
            let config = {
                hostid: data.hostid,
                host: rowData.zbxData.host,
                name: data.Status,
                groups: hostgroups,
                //tags: tags
            }
            console.log("Perform update",config);
            //return;
            zbx.update("host",config).then(()=>console.log("Done",config));
        })
    }

	
	function load_api_key(src) {
        $.get("./zbx_api_key.txt").then(data=>{
            src.form.token.value = data;
        });
    }
    function load_api_url(src) {
        $.get("./zbx_url.txt").then(data=>{
            src.form.url.value = data;
        });
    }

    function save_zbx_config(form) {
        $("#zbxLogo").addClass("notConnected");
        localStorage.setItem("zbxUrl",form.url.value);
        localStorage.setItem("zbxToken",form.token.value);
        zbx_connect();
    }
    
    function zbx_connect() {
        let url = localStorage.getItem("zbxUrl");
        let token = localStorage.getItem("zbxToken");
        $("#zbxConfigForm")[0].url.value = url;
        $("#zbxConfigForm")[0].token.value = token;
        zbx = new ZBXApi(url,token);
        zbx.get("host",{limit:1}).then(data=>{
            if(typeof data.result!==undefined) {
                $("#zbxLogo").removeClass("notConnected");
            }
        });
    }

    
    function save_req_tpl(prefix,selectId,editor) {
        let name = prompt("Template name");
        localStorage.setItem(prefix+name,editor.getText());
        setup_req_tpl_select(selectId,prefix);
    }

    function setup_req_tpl_select(id,prefix) {
        let sel = $(id).empty();
        let prefixLen = prefix.length;
        Object.keys(localStorage)
            .filter(key=>key.indexOf(prefix)!==-1)
            .forEach(key=>$("<option>").text(key.substr(prefixLen)).attr("value",key).appendTo(sel));
    }

    const pullReqTplEditor = new JSONEditor($("#pullReqTplEditor")[0], {mode: 'code'});
    //const pushReqTplEditor = new JSONEditor($("#pushReqTplEditor")[0], {mode: 'code'});
    
    const pullReqTplPfx = "pullReqTpl_"
    const pushReqTplPfx = "pushReqTpl_"
    setup_req_tpl_select("#pullReqTemplates",pullReqTplPfx);
    setup_req_tpl_select("#pushReqTemplates",pushReqTplPfx);
    let dt = dataTable("#preview");
    $(document).ready(()=>{
        zbx_connect();
        display_data();
    });

    
</script>
</body>
</html>
